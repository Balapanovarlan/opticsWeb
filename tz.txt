Техническое задание на разработку веб‑системы «Интернет‑магазин Оптики с Системой Защиты Информации»
1. Назначение системы
Цель разработки – создание веб‑системы интернет‑магазина «Оптика», включающей пользовательский интерфейс, административную панель и комплекс встроенных механизмов обеспечения информационной безопасности (СЗИ). 
Система включает:
- клиентскую часть (React);
- серверную часть (FastAPI);
- систему хранения данных (PostgreSQL);
- механизмы аутентификации, регистрации, 2FA;
- подсистему журналирования и централизованного отображения логов;
- подсистему управления пользователями и ролями;
- подсистему защищённого обмена данными.
Система разворачивается в Docker‑окружении.
2. Требования к архитектуре системы
Архитектура — клиент‑серверная, многоуровневая.

Состав компонентов:
1) Фронтенд:
   - SPA на React;
   - взаимодействие с API только через HTTPS;
   - хранение токенов в httpOnly cookie.

2) Бэкенд (FastAPI):
   - реализация REST API;
   - обработка аутентификации, регистрации, 2FA;
   - подсистема RBAC;
   - подсистема логирования;
   - управление пользователями;
   - админские функции.

3) База данных PostgreSQL:
   - хранение пользователей, ролей, прав;
   - хранение логов в таблице audit_log;
   - хранение 2FA секретов.

4) Docker‑окружение:
   - контейнеры: frontend, backend, postgres, reverse-proxy (nginx);
   - изоляция сервисов;
   - единая сеть docker‑compose.

5) Защита каналов связи:
   - HTTPS (TLS);
   - строгая CORS‑политика.

6) Логирование:
   - запись в файл log/app.log;
   - запись в таблицу audit_log для отображения в интерфейсе.
3. Функциональные требования
3.1. Требования к пользовательской части:
- Просмотр каталога товаров (без обязательной загрузки данных).
- Возможность регистрации.
- Возможность входа в учетную запись.
- Включение/отключение двухфакторной аутентификации.
- Просмотр профиля.

3.2. Требования к админ‑панели:
- Просмотр списка пользователей.
- Создание/удаление пользователей.
- Назначение ролей (admin, staff, user).
- Включение/отключение 2FA для пользователей.
- Просмотр логов в таблице:
    * дата/время события,
    * пользователь,
    * роль,
    * тип операции,
    * объект изменения,
    * статус (успех/ошибка).

3.3. Поддерживаемые роли:
- Administrator — полный доступ.
- Staff — ограниченные административные действия.
- User — стандартный пользователь.
4. Требования к аутентификации
4.1. Регистрация:
- обязательная проверка надежности пароля:
  * длина ≥ 8;
  * наличие цифры;
  * наличие верхнего и нижнего регистра;
  * желательно наличие символов.

4.2. Авторизация:
- JWT‑токены в httpOnly cookie;
- отдельный refresh‑токен.

4.3. Двухфакторная аутентификация (2FA):
- TOTP (Google Authenticator);
- хранение секретного ключа в PostgreSQL;
- возможность включить/выключить 2FA;
- API:
    * /2fa/enable
    * /2fa/disable
    * /2fa/verify
5. Требования к логированию
Система должна обеспечивать двухуровневое логирование:

Уровень 1 — системный (файл):
- ошибки сервера;
- успешные/неуспешные входы;
- обращения к критическим API.

Подсистема прикладного логирования должна обеспечивать полный аудит действий пользователей и системных событий, включая операции, не связанные напрямую с изменением данных в БД (например: успешный вход, неуспешная попытка входа, включение 2FA, сброс пароля и т.д.).
Структура таблицы audit_log
Таблица должна содержать следующие поля:
•	id — первичный ключ, уникальный идентификатор записи;
•	timestamp — дата и время события;
•	user_id — идентификатор пользователя (NULL, если пользователь не аутентифицирован, например при ошибке входа);
•	username — имя пользователя или введённый логин (даже если вход неуспешен);
•	role — роль пользователя на момент события (admin, staff, user, либо null для неаутентифицированных);
•	operation — тип операции (login_success, login_failed, logout, 2fa_enabled, 2fa_disabled, role_changed, user_created, product_view, unknown_action и т.д.);
•	target_table — имя таблицы или сущности, над которой выполнялось действие (NULL для событий входа/выхода);
•	target_id — ID записи в этой таблице (NULL для событий входа/выхода);
•	status — состояние операции (success / failed / warning);
•	ip_address — IP-адрес клиента;
•	details (рекомендуемое дополнительное поле) — текстовое описание операции (например: "User tried to login with wrong password").

События:
- регистрация пользователя;
- вход/выход;
- изменение ролей;
- изменение данных пользователя;
- ошибочные попытки авторизации;
- админские операции.
Подсистема должна фиксировать как минимум следующие группы событий:
1. Аутентификация и безопасность
•	успешный вход пользователя (login_success);
•	неуспешная попытка входа (неверный пароль, неверный TOTP) (login_failed);
•	выход (logout);
•	включение двухфакторной аутентификации (2fa_enabled);
•	отключение двухфакторной аутентификации (2fa_disabled);
•	ошибка проверки TOTP (2fa_failed);
•	сброс пароля администратором (password_reset_admin).
2. Операции администраторов
•	создание пользователя;
•	изменение роли;
•	блокировка/разблокировка пользователя;
•	удаление пользователя;
•	просмотр логов;
•	изменение настроек безопасности.
3. Операции над данными
(Даже если товара нет, логика должна быть подготовлена)
•	просмотр списка товаров;
•	изменение данных;
•	удаление данных;
•	создание записи;
•	попытка обращения к запрещённому ресурсу (forbidden_access).

Админ‑панель должна обеспечить просмотр журналов в виде таблицы с пагинацией.
5.4. Интерфейс просмотра логов в админ-панели
Административная панель должна предоставлять страницу “Журнал событий”, которая:
1. Отображает таблицу всех записей аудита
Минимальные поля в интерфейсе:
•	Дата/время
•	Пользователь
•	Роль
•	Операция
•	Объект
•	Статус
•	IP-адрес
2. Поддерживает фильтры:
Фильтрация по:
•	диапазону даты/времени;
•	роли пользователя;
•	типу операции (operation):
login_success, login_failed, role_changed, 2fa_enabled и т.д.;
•	статусу (status: success, failed);
•	IP-адресу;
•	пользователю (username / user_id).
3. Поддерживает сортировку:
•	по дате (ASC/DESC);
•	по роли;
•	по типу операции;
•	по пользователю;
•	по статусу.
4. Поддерживает пагинацию (например: limit/offset или cursor-based).
________________________________________
5.5. Требования к API логов (FastAPI)
Должно быть реализовано API:
Получение логов:
GET /admin/logs?page=&limit=&from_date=&to_date=&role=&operation=&status=&username=
Просмотр детальной информации о событии:
GET /admin/logs/{id}
Только роли admin и staff имеют доступ к логам.
Роль staff видит ограниченный набор событий, согласно RBAC.

6. Требования к администрированию пользователей
- Создание пользователей администратором.
- Принудительное назначение ролей.
- Просмотр полного списка пользователей.
- Блокировка/разблокировка пользователя.
- Сброс 2FA.
- Логи всех операций должны сохраняться.
7. Требования к безопасности
- Использование HTTPS.
- Хранение токенов в httpOnly cookie.
- Ограничение числа попыток входа.
- Пароли только в хэшированном виде (bcrypt).
- Защита от CSRF, XSS, SQL‑инъекций.
- Ограничение доступа по ролям (RBAC).
- Все админские операции — только авторизованным администраторам.
8. Требования к БД (PostgreSQL)
Минимальные таблицы:
- users (id, username, email, password_hash, role, is_2fa_enabled, secret_2fa)
- audit_log
- roles (если роли вынесены отдельно)

Требования:
- строгие внешние ключи;
- индексы на username, email;
- транзакционность изменений ролей;
- миграции Alembic.
9. Требования к API (FastAPI)
Основные маршруты:

Аутентификация:
- POST /auth/register
- POST /auth/login
- POST /auth/logout
- POST /auth/refresh

2FA:
- POST /2fa/enable
- POST /2fa/verify
- POST /2fa/disable

Пользователи:
- GET /admin/users
- POST /admin/users
- PUT /admin/users/{id}
- DELETE /admin/users/{id}
- PUT /admin/users/{id}/role

Логи:
- GET /admin/logs?page=&limit=

Каталог:
- GET /products (mock)
10. Требования к контейнеризации (Docker)
docker-compose.yml должен включать:
- backend (FastAPI)
- postgres


